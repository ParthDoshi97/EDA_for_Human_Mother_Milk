---
title: "NUTRISHIELD_Study_II_QTrap_Targeted_Urine_EDA"
author: "Parth Doshi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      echo = TRUE,
                      cache = TRUE)
```

## Exploratory Data Analysis for NUTRISHIELD Study II QTrap Targeted Urine Sample
 In this we wiil explore quantative(targeted) food biomarkers 
## Required library

```{r message=FALSE, warning=FALSE}
# install required library
library(devtools)
#devtools::install_github("sfirke/janitor")

# load Required libraries
library(tidyverse) # meta package of all tidyverse packages
library(janitor)
library(ggplot2)
library(caret)
library(ggcorrplot)
library(FactoMineR)
library(ggfortify)
library(factoextra)
library(reshape2)
library(ggbiplot)
library(stringr)
library(corrplot)
library(moments)
library(skimr)
library(car)
```

## Data importing

```{r}
# Set Working Directory
setwd("C:/Users/Parth Doshi/Dropbox/Nutrishield_Study_II_Project (ParthD thesis)/R-script/EDA_for_Human_Mother_Milk")

# load Data set
NSII_Qtrap_Targeted_Urine <- read.csv("C:/Users/Parth Doshi/Dropbox/Nutrishield_Study_II_Project (ParthD thesis)/NSII_Corrected_and_Clean_Data/NSII_Qtrap_Targeted_Urine.csv", dec=",")

str(NSII_Qtrap_Targeted_Urine)
```

## Data Cleaning 

```{r}
# Data cleaning for Targeted Biomarkers Data

# Select the columns containing "IU" or "MU" in their names
NSII_Qtrap_Targeted_Urine <- NSII_Qtrap_Targeted_Urine %>%
   select(-X,-Class) %>%
  as.data.frame()

# Select columns 2 to 13 and convert them to numeric using lapply
NSII_Qtrap_Targeted_Urine[, 2:28] <- lapply(NSII_Qtrap_Targeted_Urine[, 2:28], as.numeric)


# Display the Summary statistic
skimmed_target <-  skim(NSII_Qtrap_Targeted_Urine)
skimmed_target
```

### Remove feature with constant value

```{r}
# Function to check if features has Constant value or very few unique values
check.constant.or.few.unique <- function(data) {
 result <- vector("character", length = ncol(data))
 
 for (i in 1:ncol(data)) {
   column <- data[[i]]
   
   if (length(unique(column)) == 1) {
     result[i] <- "Constant value"
   } else if (length(unique(column)) <= 50) {
     result[i] <- "Few unique values"
   } else {
     result[i] <- "No pattern"
   }
 }
 pattern_columns <- names(data)[result != "No pattern"]
 return(pattern_columns)
}
results <- check.constant.or.few.unique(NSII_Qtrap_Targeted_Urine)
print(results)
```

##### Remove the variable with constant value and few unique values 

```{r}
NSII_Qtrap_Targeted_Urine <- NSII_Qtrap_Targeted_Urine %>% 
  select(-`X3.IPA`,-Daidzein,-Equol,-Glycitein,-Genistein, -Kaempferol)
```

### Data Preprocessing 

```{r warning=FALSE}
# Data Distribution
# Gather columns 3 to 14 into a long format
NSII_Qtrap_Targeted_Urine_long_A <- gather(NSII_Qtrap_Targeted_Urine[2:10])

# Gather columns 15 to 24 into a long format
NSII_Qtrap_Targeted_Urine_long_B <- gather(NSII_Qtrap_Targeted_Urine[11:21])

# Generate a box plot for NSII_Qtrap_Targeted_Urine.long.A
ggplot(NSII_Qtrap_Targeted_Urine_long_A, aes(x = value, y = key, fill = key)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Data Distribution box plot before normalization")

# Generate a box plot for NSII_Qtrap_Targeted_Urine_long_B
ggplot(NSII_Qtrap_Targeted_Urine_long_B, aes(x = value, y = key, fill = key)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Data Distribution box plot before normalization")
```

### Standardization 
```{r warning=FALSE}
# Apply normalizatiomn to the data
# using caret lib to preprocess data
Normalise <- preProcess(NSII_Qtrap_Targeted_Urine, method = c("YeoJohnson"),na.remove = TRUE )

# standardize the preprocessed data
NSII_Qtrap_Targeted_Urine_Normalised <- predict(Normalise,NSII_Qtrap_Targeted_Urine)

# using caret lib to preprocess data
Scaling <- preProcess(NSII_Qtrap_Targeted_Urine_Normalised, method = c("center", "scale"),na.remove = TRUE )

# standardize the preprocessed data
NSII_Qtrap_Targeted_Urine_Normalised_scaled<- predict(Scaling,NSII_Qtrap_Targeted_Urine_Normalised)

# Generate summary statistics for the transformed data
skimmed_target_normal <- skim_to_list(NSII_Qtrap_Targeted_Urine_Normalised_scaled)
skimmed_target_normal


# Box plot after the transformation
NSII_Qtrap_Targeted_Urine_Normalised_scaled_long_A <- gather(NSII_Qtrap_Targeted_Urine_Normalised_scaled[2:10])
NSII_Qtrap_Targeted_Urine_Normalised_scaled_long_B <- gather(NSII_Qtrap_Targeted_Urine_Normalised_scaled[11:21])

# Generate a box plot for NSII_Qtrap_Targeted_Urine_Normalised_scaled.long.A
ggplot(NSII_Qtrap_Targeted_Urine_Normalised_scaled_long_A, aes(x = value, y = key, fill = key)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Data Distribution box plot before normalization") +
  xlim(-1, 5)

# Generate a box plot for NSII_Qtrap_Targeted_Urine_Normalised_scaled_long_B
ggplot(NSII_Qtrap_Targeted_Urine_Normalised_scaled_long_B, aes(x = value, y = key, fill = key)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Data Distribution box plot after normalization") +
  xlim(-1, 5)

```

```{r}
# Box plot of data distribution of each group (Mother , PI , TI)
NSII_Qtrap_Targeted_Urine_Normalised_scaled %>%
  gather(key = "feature", value = "value", -Sample, -NewClass, -Month, -Type, -ID) %>%
  ggplot(aes(x = NewClass, y = value, fill = NewClass)) +
  geom_boxplot() +
  facet_wrap(~ feature, scales = "free") +
  labs(x = "Group", y = "Value") 
```

```{r}
# Removing the variable which has large  no of outliers  
NSII_Qtrap_Targeted_Urine_Normalised_scaled <- NSII_Qtrap_Targeted_Urine_Normalised_scaled %>% 
  select(-Quercetin, -Phloretin)
```

```{r}
# Principle component Analysis
NSII_Qtrap_Targeted_Urine_Normalised_scaled.pca <- prcomp(NSII_Qtrap_Targeted_Urine_Normalised_scaled[2:19], scale. = TRUE, center = TRUE)

#Visualization of PCA
fviz_pca_ind(NSII_Qtrap_Targeted_Urine_Normalised_scaled.pca,
             geom = "point",
             habillage = NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass,
             palette = c("blue", "red","green"),
             addEllipses = TRUE,
             ellipse.type="confidence",
             ggtheme = theme_bw(),
             title = "PCA plot for Qtrap targeted biomarkrs")

#Scree plot 
fviz_eig(NSII_Qtrap_Targeted_Urine_Normalised_scaled.pca, 
         addlabels = TRUE, 
         ylim = c(0, 70),
         main="Scree Plot Qtrap targeted Biomarkers")

#Graph for variable
fviz_pca_var(NSII_Qtrap_Targeted_Urine_Normalised_scaled.pca, col.var = "red")
 

```
## Correlation & Covariance
```{r}
# Calculate p-values for each correlation coefficient
p.mat <- cor_pmat(NSII_Qtrap_Targeted_Urine_Normalised_scaled[2:19], method = "pearson")

# Calculate correlation matrix using Pearson correlation
correlationMatrix <- cor(NSII_Qtrap_Targeted_Urine_Normalised_scaled[2:19], method = "pearson")

# Visualize the correlation matrix using ggcorrplot
ggcorrplot(
  correlationMatrix,
  hc.order = TRUE,   # Hierarchical clustering for reordering variables
  type = "lower",    # Show only the lower triangle of the correlation matrix
  lab = FALSE,        # Show labels for variables
  p.mat = p.mat      # Overlay p-values on the plot
)

# Calculate the covariance matrix using Pearson correlation
cov_df <- cov(NSII_Qtrap_Targeted_Urine_Normalised_scaled[sapply(NSII_Qtrap_Targeted_Urine_Normalised_scaled, is.numeric)], method = "pearson")

# Convert covariance matrix to correlation matrix
cov_df <- cov2cor(cov_df)

# Reshape the correlation matrix to long format
cov_df_long <- melt(cov_df)

# Create the covariance plot using ggplot2
plot <- ggplot(cov_df_long, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(high = "red", low = "white") +
  geom_text(aes(label = paste0(round(value * 100, 2))), color = "black", size = 3) +
  labs(title = "Covariance Heatmap",
       x = "Variable 1",
       y = "Variable 2")

# Print the covariance plot
print(plot)

```
### Test of Homogeneity of Variance and Normality 

##### shapiro test for Normality
```{r}
library(rstatix)
# Define the Continuous Variables
continuous_vars <- colnames(NSII_Qtrap_Targeted_Urine_Normalised_scaled[2:19])

categorical_var <- "NewClass"
NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass <- factor(NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass)

# Initialize an empty data frame to store the results
shapiro_results <- data.frame(Variable = character(0), P_Value = numeric(0), Significant = character(0), stringsAsFactors = FALSE)

# Loop through the continuous variables
for (vars in continuous_vars) {
  data_vector <- NSII_Qtrap_Targeted_Urine_Normalised_scaled[[vars]]
  shapiro_result <- shapiro.test(data_vector)
  
  # Append the results to the data frame
  shapiro_results <- rbind(shapiro_results, data.frame(Variable = vars, P_Value = shapiro_result$p.value, Significant = ifelse( shapiro_result$p.value < 0.05, "**", "-")))
}

# Print the results as a table
print(shapiro_results)


```

#### Levene's test

```{r}

# perform levene's test to see if all group has equal variance

# Update the levels of the New Class variable
NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass <- factor(NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass)


# Initialize an empty data frame to store the results
levene_results <- data.frame(Variable = character(0), F_Value = numeric(0), P_Value = numeric(0), stringsAsFactors = FALSE)

# Loop through the continuous variables
for (vars in continuous_vars) {
  formula <- as.formula(paste(vars, "~", categorical_var))
  var_test <- leveneTest(formula, data = NSII_Qtrap_Targeted_Urine_Normalised_scaled)
  levene_results <- rbind(levene_results, data.frame(Variable = vars, F_Value = var_test$`F value`, P_Value = var_test$`Pr(>F)`, Significant = ifelse(var_test$`Pr(>F)` < 0.05, "**", "-")))
}

print(levene_results)
```

#### Kruskal-Wallis test

```{r}
# Perform Kruskal-Wallis test for each variable
# Initialize an empty data frame to store the Kruskal-Wallis results
kruskal_results <- data.frame(Variable = character(0), H_Statistic = numeric(0), P_Value = numeric(0), stringsAsFactors = FALSE)

# Loop through the continuous variables
for (vars in continuous_vars) {
  formula <- as.formula(paste(vars, "~", categorical_var))
  kruskal_model <- kruskal.test(formula, data = NSII_Qtrap_Targeted_Urine_Normalised_scaled)
  
  # Append the results to the data frame
  kruskal_results <- rbind(kruskal_results, data.frame(Variable = vars, H_Statistic = kruskal_model$statistic, P_Value = kruskal_model$p.value, Significant = ifelse(kruskal_model$p.value < 0.05, "**", "-")))

}
print(kruskal_results)

# Perform Pairwise Comparsion Test
for (vars in continuous.vars) {
  formula <- as.formula(paste(vars, "~", categorical.var))
  Pairwise_Test <- dunn_test(formula, data = NSII_Qtrap_Targeted_Urine_Normalised_scaled)
  cat("Variable:", vars, "\n")
  print(Pairwise_Test)
  cat("\n")
}

```



```{r}
library(ggstatsplot)
library(rlang)

StatBoxplot <- function(y) {
  y_sym <- sym(y)
  plot <- ggbetweenstats(
    data = NSII_Qtrap_Targeted_Urine_Normalised_scaled,
    x = NewClass,
    y = !!y_sym,
    type = "parametric",
    plot.type = "box",
    pairwise.comparisons = TRUE,
    pairwise.display = "all",
    centrality.plotting = FALSE,
    bf.message = FALSE,
    ylab = y
  )
  
  return(plot)
}

Targeted_Biomakers<- colnames(NSII_Qtrap_Targeted_Urine_Normalised_scaled)[2:19]

# Call the StatBoxplot function for each variable in the variables vector
for (BM in Targeted_Biomakers) {
  plot <- StatBoxplot(BM)
  print(plot) # If you want to see each plot, use print() to display them.
}
```

### Regression Test

```{r}
# perform regression 
for (Vars in continuous.vars) {
  formula <- as.formula(paste(Vars, "~", categorical.var))
  Lm.model <-lm(formula, data = NSII_Qtrap_Targeted_Urine_Normalised_scaled)
  cat("Variable:",Vars, "\n")
  print(summary(Lm.model))
  cat("\n")
}
```


## Feature selection
#### Feature Selection Using Recursive feature elimination Method
```{r}
set.seed(123)

NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass <- factor(NSII_Qtrap_Targeted_Urine_Normalised_scaled$NewClass)
# define the control using a random forest selection function
control <- rfeControl(functions=rfFuncs, method="cv", number=10)
# run the RFE algorithm
results <- rfe(NSII_Qtrap_Targeted_Urine_Normalised_scaled[,2:19], NSII_Qtrap_Targeted_Urine_Normalised_scaled[,24], sizes=c(1:22), rfeControl=control)
# summarize the results
print(results)
# list the chosen features
predictors(results)


library(Boruta)
# Decide if a variable is important or not using Boruta
boruta_output <- Boruta(NewClass ~ ., data=na.omit(NSII_Qtrap_Targeted_Urine_Normalised_scaled), doTrace=2)  # perform Boruta search

boruta_signif <- names(boruta_output$finalDecision[boruta_output$finalDecision %in% c("Confirmed", "Tentative")])  # collect Confirmed and Tentative variables

# plot variable
plot(boruta_output, cex.axis=.7, las=2, xlab="", main="Variable Importance")  
```