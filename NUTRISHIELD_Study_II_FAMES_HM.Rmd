---
title: "NUTRISHIELD_Study_II_FAMES_HM"
author: "Parth Doshi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      echo = TRUE,
                      cache = FALSE)
```

## Exploratory Data Analysis for NUTRISHIELD Study II FAMES Human Milk Sample

## Required library

```{r message=FALSE, warning=FALSE}
# install required library
library(devtools)
#devtools::install_github("sfirke/janitor")

# load Required libraries
library(tidyverse) # meta package of all tidyverse packages
library(janitor) # 
library(ggplot2)
library(corrplot)
library(caret)
library(stringr)
library(FactoMineR)
library(ggfortify)
library(ggcorrplot)
library(factoextra)
library(reshape2)
library(Boruta)
library(moments)
library(skimr)
library(car)
```

```{r}
# Set Working Directory
setwd("C:/Users/Parth Doshi/Dropbox/Nutrishield_Study_II_Project (ParthD thesis)/R-script/EDA_for_Human_Mother_Milk")
```

## Data importing & Cleaning

```{r}
# Load the NSII_FAMES_HM from the CSV file
NSII_FAMES_HM <- read.csv("C:/Users/Parth Doshi/Dropbox/Nutrishield_Study_II_Project (ParthD thesis)/NSII_Corrected_and_Clean_Data/NSII_FAMES_HM.csv", dec=",")

NSII_FAMES_HM <- NSII_FAMES_HM %>%
  select(-1,-Class) %>%
  # Remove columns with any missing values
  select_if(~ !any(is.na(.))) %>%
  as.data.frame() 
  
# Select columns 2 to 37 and convert them to numeric using lapply
NSII_FAMES_HM[, 2:37] <- lapply(NSII_FAMES_HM[, 2:37], as.numeric)


# summary Stats
skimmed_FAMES <- skim(NSII_FAMES_HM)
skimmed_FAMES
```

### Remove feature with constant value

```{r}
check.constant.or.few.unique <- function(data) {
 result <- vector("character", length = ncol(data))
 
 for (i in 1:ncol(data)) {
   column <- data[[i]]
   
   if (length(unique(column)) == 1) {
     result[i] <- "Constant value"
   } else if (length(unique(column)) <= 10) {
     result[i] <- "Few unique values"
   } else {
     result[i] <- "No pattern"
   }
 }
 pattern_columns <- names(data)[result != "No pattern"]
 return(pattern_columns)
}
results <- check.constant.or.few.unique(NSII_FAMES_HM)
print(results)
```

### Remove the variable with constant value and few unique values

```{r}
NSII_FAMES_HM <- NSII_FAMES_HM %>% 
  select(-Undecanoate,-Tridecanoate,-Tricosanoate,-Heneicosanoate,-Docosanoate,-`cis.10.Pentadecenoic`,-`cis.11.14.17.Eicosatrienoic`)

# Checking Skewness 
skewness(NSII_FAMES_HM[2:30])
```

## Normalization and Scaling of Data

```{r}
# Normailization of  data
Preprocess <- preProcess(NSII_FAMES_HM, method = "BoxCox")
# standardize the preprocessed data
NSII_FAMES_HM_Normal <- predict(Preprocess,NSII_FAMES_HM)

# Scaling of  data
Autoscale <- preProcess(NSII_FAMES_HM_Normal, method = c("center","scale"))
# standardize the preprocessed data
NSII_FAMES_HM_Normal_Scaled<- predict(Autoscale, NSII_FAMES_HM_Normal)

#NSII_FAMES_HM_Normal <- NSII_FAMES_HM_Normal %>%
#  replace(sapply(., is.infinite), 0) %>%
#  replace(sapply(.,is.na), 0)
  

skewness(NSII_FAMES_HM_Normal_Scaled[2:30])

skimmed_FAMES_Scale <- skim(NSII_FAMES_HM_Normal_Scaled)
skimmed_FAMES_Scale



# Converting it into long 
NSII_FAMES_HM_Normal_Scaled.long <- gather(NSII_FAMES_HM_Normal_Scaled[2:15])
NSII_FAMES_HM_Normal_Scaled.long.subset <- gather(NSII_FAMES_HM_Normal_Scaled[16:30])

# box plot after distribution
NSII_FAMES_HM_Normal_Scaled.boxplot.A <- ggplot(NSII_FAMES_HM_Normal_Scaled.long, aes(x = value, y = key, fill = key))+
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Scaled FAMES Data Boxplot",)
print(NSII_FAMES_HM_Normal_Scaled.boxplot.A)


# box plot after distribution
NSII_FAMES_HM_Normal_Scaled.boxplot.B <- ggplot(NSII_FAMES_HM_Normal_Scaled.long.subset, aes(x = value, y = key, fill = key))+
  geom_boxplot(outlier.colour = "red", outlier.shape = 1) +
  labs(title = "Scaled FAMES Data Boxplot",)
print(NSII_FAMES_HM_Normal_Scaled.boxplot.B)
```

### Box plot of data distribution of each group (Post,Pre,PI,TI)

```{r}
NSII_FAMES_HM_Normal_Scaled_A <- NSII_FAMES_HM_Normal_Scaled[, c(1:15, 31)]
NSII_FAMES_HM_Normal_Scaled_B <- cbind(NSII_FAMES_HM_Normal_Scaled[1], NSII_FAMES_HM_Normal_Scaled[16:31])
str(NSII_FAMES_HM_Normal_Scaled_A)

# Define the boxplot function
boxplot <- function(data) {
  data %>%
    pivot_longer(cols = -c(Samples, NewClass), names_to = "feature", values_to = "value") %>%
    ggplot(aes(x = NewClass, y = value, fill = NewClass)) +
    geom_boxplot() +
    facet_wrap(~ feature, scales = "free") +
    labs(title = "Boxplot of NSII_FAMES_HM_Normal_Scaled",
         x = "NewClass",
         y = "Value")
}


# Create the boxplot for NSII_FAMES_HM_Normal_Scaled_A
NSII_FAMES_HM_Normal_Scaled_A_boxplot <- boxplot(NSII_FAMES_HM_Normal_Scaled_A)
print(NSII_FAMES_HM_Normal_Scaled_A_boxplot)

# Create the boxplot for NSII_FAMES_HM_Normal_Scaled_B
NSII_FAMES_HM_Normal_Scaled_B_boxplot <- boxplot(NSII_FAMES_HM_Normal_Scaled_B)
print(NSII_FAMES_HM_Normal_Scaled_B_boxplot)


```

## Correlation plot

```{r}
# Calculate p-values for each correlation coefficient
p_mat <- cor_pmat(NSII_FAMES_HM_Normal_Scaled[2:30], method = "pearson")

# Calculate correlation matrix using Pearson correlation
correlationMatrix <- cor(NSII_FAMES_HM_Normal_Scaled[3:30], method = "pearson")

# Visualize the correlation matrix using ggcorrplot
ggcorrplot(
  correlationMatrix,
  hc.order = FALSE,   # Hierarchical clustering for reordering variables
  type = "lower",    # Show only the lower triangle of the correlation matrix
  lab = FALSE        # Show labels for variables     
)
```

### statistical tests to find relationship between categorical variable and a continuous variable.

```{r}
library(rstatix)

# Get the names of the continuous variables
continuous_vars <- colnames(NSII_FAMES_HM_Normal_Scaled[2:30])
categorical_var <- "NewClass"


# Initialize an empty data frame to store the results
shapiro_results <- data.frame(Variable = character(0), P_Value = numeric(0), Significant = character(0), stringsAsFactors = FALSE)

# Loop through the continuous variables
for (vars in continuous_vars) {
  data_vector <- NSII_FAMES_HM_Normal_Scaled[[vars]]
  shapiro_result <- shapiro.test(data_vector)
  
  # Append the results to the data frame
  shapiro_results <- rbind(shapiro_results, data.frame(Variable = vars, P_Value = shapiro_result$p.value, Significant = ifelse( shapiro_result$p.value < 0.05, "**", "-")))
}

print(shapiro_result)
```

### Levene's test for Homogeneity of Variance

```{r}

# Catgorial variable to Factor
NSII_FAMES_HM_Normal_Scaled$NewClass <- factor(NSII_FAMES_HM_Normal_Scaled$NewClass)

# Initialize an empty data frame to store the results
levene_results <- data.frame(Variable = character(0), F_Value = numeric(0), P_Value = numeric(0), stringsAsFactors = FALSE)

# Loop through the continuous variables
for (vars in continuous_vars) {
  formula <- as.formula(paste(vars, "~", categorical_var))
  var_test <- leveneTest(formula, data = NSII_FAMES_HM_Normal_Scaled)
  levene_results <- rbind(levene_results, data.frame(Variable = vars, F_Value = var_test$`F value`, P_Value = var_test$`Pr(>F)`, Significant  = ifelse(var_test$`Pr(>F)` < 0.05, "**", "-")))
}

print(levene_results)
```

### Kruskal walis Test

```{r}
# Perform Kruskal-Wallis test for each variable
# Initialize an empty data frame to store the Kruskal-Wallis results
kruskal_results <- data.frame(Variable = character(0), H_Statistic = numeric(0), P_Value = numeric(0), stringsAsFactors = FALSE)

# Loop through the continuous variables
for (vars in continuous_vars) {
  formula <- as.formula(paste(vars, "~", categorical_var))
  kruskal_model <- kruskal.test(formula, data = NSII_FAMES_HM_Normal_Scaled)
  
  # Append the results to the data frame
  kruskal_results <- rbind(kruskal_results, data.frame(Variable = vars, H_Statistic = kruskal_model$statistic, P_Value = kruskal_model$p.value, Significant = ifelse(kruskal_model$p.value < 0.05, "**", "-")))

}
print(kruskal_results)


# Perform Kruskal-Wallis test for each variable
for (vars in continuous.vars) {
  formula <- as.formula(paste(vars, "~", categorical.var))
 pairwise_test <- dunn_test(formula, data = NSII_FAMES_HM_Normal_Scaled)
  cat("Variable:", vars, "\n")
  print(pairwise_test)
  cat("\n")
}
```

#### Regression test

```{r}
for (var in continuous.vars) {
  # Create a formula specifying the relationship between the continuous variable and the categorical variable
  formula <- as.formula(paste(var, "~ NewClass"))
  
  # Fit the linear regression model
  regression.model <- lm(formula, data = NSII_FAMES_HM_Normal_Scaled)
  
  # Print the regression coefficients and summary
  cat("Variable:", var, "\n")
  print(coef(regression.model))
  cat("\n")
  print(summary(regression.model))
  cat("\n")
}

```

##### Principle component Analysis

```{r}
NSII_FAMES_HM_PCA <- prcomp(NSII_FAMES_HM_Normal_Scaled[3:27], scale. = TRUE, center = TRUE)

#Visualization of PCA
fviz_pca_ind(NSII_FAMES_HM_PCA,
             geom = "point",
             habillage = NSII_FAMES_HM_Normal_Scaled$NewClass,
             palette = c("blue", "red","green","yellow"),
             addEllipses = TRUE,
             ellipse.type="confidence",
             ggtheme = theme_bw(),
             title = "PCA plot for HM Fatty Acids")
#Scree plot 
fviz_eig(NSII_FAMES_HM_PCA, 
         addlabels = TRUE, 
         ylim = c(0, 70),
         main="Scree Plot Fatty Acids")

#Graph for variable
fviz_pca_var(NSII_FAMES_HM_PCA, col.var = "red")
```

# feature selection

```{r}
NSII_FAMES_HM_Normal_Scaled$NewClass <- factor(NSII_FAMES_HM_Normal_Scaled$NewClass)

# define the control using a random forest selection function
control <- rfeControl(functions=rfFuncs, method="cv", number=10)
# run the RFE algorithm
results <- rfe(NSII_FAMES_HM_Normal_Scaled[,2:30], NSII_FAMES_HM_Normal_Scaled[,31], sizes=c(1:27), rfeControl=control)
# summarize the results
print(results)
# list the chosen features
predictors(results)


library(Boruta)
# Decide if a variable is important or not using Boruta
boruta_output <- Boruta(NewClass ~ ., data = na.omit(NSII_FAMES_HM_Normal_Scaled), doTrace = 2)  # perform Boruta search

boruta_signif <- names(boruta_output$finalDecision[boruta_output$finalDecision %in% c("Confirmed", "Tentative")])  # collect Confirmed and Tentative variables

plot(boruta_output, cex.axis=.7, las= 2, xlab = "", main = "Variable Importance")  # plot variable
```
